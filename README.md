## Fan Xu Complex SQL Query for a MySQL Database

[![CI](https://github.com/nogibjj/fan_xu_sql_db/actions/workflows/cicd.yml/badge.svg)](https://github.com/nogibjj/fan_xu_sql_db/actions/workflows/cicd.yml)

This project is for practicing interacting with an external Database using a python script, in this case DataBricks. After connecting to the database, a complex SQL query involving joins, aggregation, and sorting is run. 

### Requirements:

- Design a complex SQL query involving joins, aggregation, and sorting
- Provide an explanation for what the query is doing and the expected results

### Project Structure

```
ðŸ“¦ fan_xu_sql_db
â”œâ”€Â .devcontainer
â”‚Â Â â”œâ”€Â Dockerfile
â”‚Â Â â””â”€Â devcontainer.json
â”œâ”€Â .github
â”‚Â Â â””â”€Â workflows
â”‚Â Â Â Â Â â””â”€Â cicd.yml
â”œâ”€Â .gitignore
â”œâ”€Â Dockerfile
â”œâ”€Â LICENSE
â”œâ”€Â Makefile
â”œâ”€Â README.md
â”œâ”€Â data
â”‚Â Â â””â”€Â historical_projections.csv
â”œâ”€Â main.py
â”œâ”€Â mylib
â”‚Â Â â”œâ”€Â __init__.py
â”‚Â Â â”œâ”€Â extract.py
â”‚Â Â â”œâ”€Â query.py
â”‚Â Â â””â”€Â transform_load.py
â”œâ”€Â requirements.txt
â”œâ”€Â setup.sh
â””â”€Â test_main.py
```
Â©generated by [Project Tree Generator](https://woochanleee.github.io/project-tree-generator)


### Data:

historical_projections.csv contains historical results of the NBA draft projection model, 2001-2015.

The dataset contains the data behind the story [Projecting The Top 50 Players In The 2015 NBA Draft Class](http://fivethirtyeight.com/features/projecting-the-top-50-players-in-the-2015-nba-draft-class/). It can be accessed [here](https://github.com/fivethirtyeight/data/tree/master/nba-draft-2015)

### Steps:

1. Connect to Databricks with an .env file including the Databricks token, server hostname, and http path.

```
import os
from databricks import sql
from dotenv import load_dotenv

    load_dotenv()
    with sql.connect(
        server_hostname=os.getenv("DATABRICKS_SERVER_HOSTNAME"),
        http_path=os.getenv("DATABRICKS_HTTP_PATH"),
        access_token=os.getenv("DATABRICKS_TOKEN"),
    ) as connection:
```

- Make sure to include `databricks-sql-connector` and `python-dotenv` in the requirements.txt
- If running CI/CD through GitHub actions, secrets can be created for the repository to access the .env values for Databricks. Include this code in the CI/CD yml file to access them

```
env:
    DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_SERVER_HOSTNAME }}
    DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
```

2. Create your table in Databricks and insert your values if necessary

```
cursor.execute("CREATE TABLE IF NOT EXISTS table_name")
```

3. Perform your query

### Query Explanation

```
WITH bust_chance AS (
  SELECT Position,
  AVG(Bust) AS bust_avg,
  COUNT(Position) AS position_count
  FROM default.nba_2015
  GROUP BY Position
)

SELECT * FROM nba_2015
JOIN bust_chance 
ON nba_2015.Position = bust_chance.Position
ORDER BY bust_chance.bust_avg DESC;
```

In this query, a CTE (common table expression) called `bust_chance` is created that has additional aggregated information about NBA players grouped by position. The columns in this CTE consist of the position of each player, the average bust chance for that position, as well as the number of players in that position. This CTE is joined to the original table on the position column, and the joined table is ordered by descending bust chance. The expected output would then be all columns and rows of the original dataset with 3 additional columns added by the join. 